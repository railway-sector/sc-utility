"use strict";(self.webpackChunksc_utility=self.webpackChunksc_utility||[]).push([[3595],{3595:(e,t,i)=>{i.d(t,{L:()=>le});var s=i(35143),n=i(18690),a=i(50076),r=i(87663),h=i(30726),o=i(50346),l=i(46053),c=(i(81806),i(76460),i(85842)),d=i(13191),_=i(20664),u=i(9392),g=i(55855),f=i(22955),p=i(57481),m=i(48549),I=i(33062),v=i(34981),y=i(60586),A=i(32119),T=i(89596),E=i(50248),b=i(94536),C=i(77730),S=i(86994),L=i(66470),R=i(91967),O=i(54099),M=i(63919),x=i(44680),D=i(34761),w=i(88105),F=i(94966),N=i(76718),H=i(93345);class V{constructor(e,t,i){this._elementSize=t,this._buffer=N.g.createVertex(e,H._U.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const n=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,s=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}}class U{constructor(e){this.modelOriginHi=e.getField(L.r.INSTANCEMODELORIGINHI,w.xs),this.modelOriginLo=e.getField(L.r.INSTANCEMODELORIGINLO,w.xs),this.model=e.getField(L.r.INSTANCEMODEL,w.jZ),this.modelNormal=e.getField(L.r.INSTANCEMODELNORMAL,w.jZ),this.featureAttribute=e.getField(L.r.INSTANCEFEATUREATTRIBUTE,w.Eq),this.color=e.getField(L.r.INSTANCECOLOR,w.XP),this.objectAndLayerIdColor=e.getField(L.r.INSTANCEOBJECTANDLAYERIDCOLOR,w.XP)}}class B{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var e,t;return null!==(e=null===(t=this._buffer)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,S.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,S.vA)(this._updating,"not updating"),this.size<n.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,S.vA)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,S.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,S.vA)(this._updating,"not updating"),(0,S.vA)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(G,Math.floor(this._capacity*n.Ji));this._resize(e)}_shrink(){const e=Math.max(G,Math.floor(this._capacity*n.He));this._resize(e)}_resize(e){if((0,S.vA)(this._updating,"not updating"),e===this._capacity)return;const t=new V(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this._compactInstances(t);(0,S.vA)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new U(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const G=64;var z,P;(P=z||(z={}))[P.ALLOCATED=1]="ALLOCATED",P[P.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",P[P.VISIBLE=4]="VISIBLE",P[P.HIGHLIGHT=8]="HIGHLIGHT",P[P.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",P[P.REMOVE=32]="REMOVE",P[P.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",P[P.ACTIVE=18]="ACTIVE";class Z{constructor(e){this.localTransform=e.getField(L.r.LOCALTRANSFORM,w.E$),this.globalTransform=e.getField(L.r.GLOBALTRANSFORM,w.E$),this.modelOrigin=e.getField(L.r.MODELORIGIN,w.Xm),this.model=e.getField(L.r.INSTANCEMODEL,w.jZ),this.modelNormal=e.getField(L.r.INSTANCEMODELNORMAL,w.jZ),this.modelScaleFactors=e.getField(L.r.MODELSCALEFACTORS,w.gH),this.boundingSphere=e.getField(L.r.BOUNDINGSPHERE,w.Aj),this.featureAttribute=e.getField(L.r.FEATUREATTRIBUTE,w.Eq),this.color=e.getField(L.r.COLOR,w.XP),this.objectAndLayerIdColor=e.getField(L.r.OLIDCOLOR,w.XP),this.state=e.getField(L.r.STATE,w.SL),this.lodLevel=e.getField(L.r.LODLEVEL,w.SL)}}let j=class extends R.A{constructor(e,t){super(e),this.events=new O.A,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=function(e){let t=(0,m.BP)().mat4f64(L.r.LOCALTRANSFORM).mat4f64(L.r.GLOBALTRANSFORM).vec4f64(L.r.BOUNDINGSPHERE).vec3f64(L.r.MODELORIGIN).mat3f(L.r.INSTANCEMODEL).mat3f(L.r.INSTANCEMODELNORMAL).vec2f(L.r.MODELSCALEFACTORS);return e.includes(L.r.FEATUREATTRIBUTE)&&(t=t.vec4f(L.r.FEATUREATTRIBUTE)),e.includes(L.r.COLOR)&&(t=t.vec4u8(L.r.COLOR)),e.includes(L.r.OLIDCOLOR)&&(t=t.vec4u8(L.r.OLIDCOLOR)),t=t.u8(L.r.STATE).u8(L.r.LODLEVEL),t}(t),this._capacity=G,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Z(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,z.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;(0,S.vA)(e>=0&&e<this._capacity&&0!==(t.get(e)&z.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,z.ACTIVE)?this._setStateFlags(e,z.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,S.vA)(e>=0&&e<this._capacity&&0!==(t.get(e)&z.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=q,s=k;t.localTransform.getMat(e,W),t.globalTransform.getMat(e,X);const n=(0,D.lw)(X,X,W);(0,_.i)(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),(0,M.z0)(s,n),t.model.setMat(e,s);const a=(0,F.wp)(q,n);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),(0,M.B8)(s,s),(0,M.mg)(s,s),t.modelNormal.setMat(e,s),this._setStateFlags(e,z.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,k),i.modelOrigin.getVec(e,q),t[0]=k[0],t[1]=k[1],t[2]=k[2],t[3]=0,t[4]=k[3],t[5]=k[4],t[6]=k[5],t[7]=0,t[8]=k[6],t[9]=k[7],t[10]=k[8],t[11]=0,t[12]=q[0],t[13]=q[1],t[14]=q[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(q,this,e),t*=Math.max(q[0],q[1],q[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(q,this,e),t*=function(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}(q[0],q[1],q[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,z.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,z.VISIBLE)}setHighlight(e,t){const{_highlightOptionsMap:i}=this,s=i.get(e);t?t!==s&&(i.set(e,t),this._setStateFlag(e,z.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):s&&(i.delete(e),this._setStateFlag(e,z.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,z.HIGHLIGHT)}geHighlightOptionsPrev(e){var t;const i=null!==(t=this._highlightOptionsMapPrev.get(e))&&void 0!==t?t:null;return this._highlightOptionsMapPrev.delete(e),i}getHighlightName(e){var t;const i=null!==(t=this.highlightOptionsMap.get(e))&&void 0!==t?t:null;return i?this._highlightOptionsMapPrev.set(e,i):this._highlightOptionsMapPrev.delete(e),i}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(G,Math.floor(this._capacity*n.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Z(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&z.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,s._)([(0,l.MZ)({constructOnly:!0})],j.prototype,"shaderTransformation",void 0),(0,s._)([(0,l.MZ)()],j.prototype,"_size",void 0),(0,s._)([(0,l.MZ)({readOnly:!0})],j.prototype,"size",null),j=(0,s._)([(0,c.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],j);const q=(0,u.vt)(),k=(0,x.vt)(),W=(0,d.vt)(),X=(0,d.vt)();var $=i(78315);class J extends b.A{constructor(e,t){super(e=>(0,$.w)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,$.c)(),this._tmpMat4=(0,d.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,_.t)((0,$.a)(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,F.hG)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Y{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){const s=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*t/s;let a=0;for(let r=1;r<this._minScreenSpaceRadii.length;++r)n>=this._minScreenSpaceRadii[r]&&(a=r);return a}}var K=i(42294),Q=i(50255),ee=i(69008);class te{constructor(e,t){const i=e.renderContext.rctx,s=t.geometry,n=t.geometry.getRenderGeometry(),a=n.material;this._materials=e.materials,a.setParameters({instancedDoublePrecision:!0}),this.geometry=s,this.material=a,this.glMaterials=new Q.c(a,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=N.g.createVertex(i,H._U.STATIC_DRAW,n.buffer),this.vao=new ee.Z(i,A.D,new Map([["geometry",(0,p.U)(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,i,s,n,a,r,h){return this.geometry.intersect(e,t,i,s,n,a,r,h)}}class ie{static async create(e,t,i){const s=await Promise.allSettled(t.components.map(t=>e.controller.schedule(()=>new te(e,t),i))),a=s.map(e=>"fulfilled"===e.status?e.value:null).filter(n.Ru);if((0,o.G4)(i)||a.length!==s.length){a.forEach(e=>e.destroy()),(0,o.Te)(i);for(const e of s)if("rejected"===e.status)throw e.reason}return new ie(t.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,i,s,n,a,r){this.components.forEach(h=>h.intersect(e,t,i,s,n,a,this.boundingSphere,r))}get boundingBox(){if(null==this._boundingBox){const e=(0,K.Ie)();this.components.forEach(t=>{null!=t.boundingInfo&&((0,K.iT)(e,t.boundingInfo.bbMin),(0,K.iT)(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,u.vt)();(0,K.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,K._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.triangleCount,0)}}var se=i(99362),ne=i(68967),ae=i(37267),re=i(1723),he=i(59752),oe=i(27207);let le=class extends y.Cc{constructor(e,t){super(e),this.type=E.d.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new I.A,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[C.N.OPAQUE_MATERIAL,e=>this._produces(e)],[C.N.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new j({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(he.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=(0,m.BP)().vec3f(L.r.INSTANCEMODELORIGINHI).vec3f(L.r.INSTANCEMODELORIGINLO).mat3f(L.r.INSTANCEMODEL).mat3f(L.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(L.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(L.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(L.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,p.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",e=>{let{index:t}=e;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",e=>{let{index:t}=e;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDataMap.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==re.Tv&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,i)=>{const s=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=e.triangleCount;t.push({renderedInstances:s,renderedTriangles:s*n,trianglesPerInstance:n})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(i=>{e.push(new B(t,this._instanceBufferLayout))}),e}async initializeRenderContext(e,t){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const i=await Promise.allSettled(this.symbol.levels.map(i=>ie.create(e,i,t))),s=i.map(e=>"fulfilled"===e.status?e.value:null).filter(n.Ru);if((0,o.G4)(t)||s.length!==i.length){s.forEach(e=>e.destroy()),(0,o.Te)(t);for(const e of i)if("rejected"===e.status)throw e.reason}this._levels=s,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map(e=>e.minScreenSpaceRadius);return new Y(t,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDataMap.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>{const t=e.material.produces.get(C.N.TRANSPARENT_MATERIAL);return null===t||void 0===t?void 0:t(v.V.Color)}))}hasHighlights(){return(0,r.Bs)(this._highlightRenderInstanceDataMap,e=>e.some(e=>e.size>0))}_produces(e){return(e!==v.V.Highlight||this.hasHighlights())&&(e!==v.V.ShadowHighlight||this.hasHighlight(re.Tv))}prepareRender(e){if(!f.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(he.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const i=new Array,s=this.levels;return t.forEach(t=>s.forEach((s,n)=>{let{components:a}=s;return a.forEach(s=>i.push(this._beginComponent(e,t[n],s)))})),i}render(e,t){const i=this._getInstanceDatas(e);if(!i||null==t)return;let s=0;e.rctx.bindVAO();const n=this.levels;i.forEach(i=>n.forEach((n,a)=>{let{components:r}=n;return r.forEach(n=>this._renderComponent(e,t[s++],i[a],n,a))}))}_getInstanceDatas(e){const{output:t,bind:i}=e,s=t===v.V.Highlight,n=t===v.V.ShadowHighlight,a=!s&&!n,r=t!==v.V.ShadowExcludeHighlight;if(a)return r?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDataMap:h}=this;if(r){if(s){var o;const e=null===(o=i.highlight)||void 0===o?void 0:o.name;if(!e)return null;const t=h.get(e);return t?[t]:null}const e=h.get(re.Tv);return n?e?[e]:null:Array.from(h.values())}return null}intersect(e,t,i,s){if(!this.baseMaterial.visible||null==this._octree)return;const n=(0,u.vt)();(0,_.d)(n,s,i);const a=n=>{this._instanceData.getCombinedModelTransform(n,ue),e.transform.set(ue),(0,_.t)(ge,i,e.transform.inverse),(0,_.t)(fe,s,e.transform.inverse);const a=this._instanceData.getState(n),r=this._instanceData.getLodLevel(n),h=this._levels.length;(0,S.vA)(0!==(a&z.ACTIVE),"invalid instance state"),(0,S.vA)(r>=0&&r<h,"invaid lod level"),this._levels[r].intersect(e,t,ge,fe,n,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(i,n,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var e;const t=this._instanceData,i=null===(e=t.view)||void 0===e?void 0:e.state;if(!i)return null;this._octreeCached=new J(t,this.baseBoundingSphere);for(let e=0;e<t.capacity;++e)i.get(e)&z.ACTIVE&&this._octreeCached.addInstance(e)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,h.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new T.d;const t=e.viewForward,i=this._octree.findClosest(t,b.A.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(t,b.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==i||null==s)return new T.d;const n=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(i,_e),(0,_.d)(_e,_e,n);const r=(0,_.e)(_e,t)-_e[3];a.boundingSphere.getVec(s,_e),(0,_.d)(_e,_e,n);const h=(0,_.e)(_e,t)+_e[3];return new T.d(r,h)}_requestUpdateCycle(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));const n=this._instanceData,h=n.view;let o=n.size;const l=n.capacity;let c=this._instanceIndex;const d=Math.ceil(l/500),{_highlightRenderInstanceDataMap:_}=this;for(let u=0;u<o&&!e.done;++u){c===this._cycleStartIndex&&this._startUpdateCycle();const u=h.state.get(c);let g=0;if(!(u&z.ALLOCATED)){c=c+1===l?0:c+1,o++;continue}const f=h.lodLevel.get(c);if(u&z.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[f].freeTail(),u&z.HIGHLIGHT_ACTIVE){const e=n.geHighlightOptionsPrev(c);if(e){const t=_.get(e);if(!t)throw new a.A("internal:lod-renderer","Internal error in lodRenderer");t[f].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),_.delete(e))}}if(u&z.REMOVE)n.freeInstance(c);else if(u&z.VISIBLE){let e=0;if(t&&(h.modelOrigin.getVec(c,de),e=s.selectLevel(de,n.getCombinedMedianScaleFactor(c),i)),g=u&~(z.ACTIVE|z.TRANSFORM_CHANGED),e>=0)if(u&z.HIGHLIGHT){const t=n.getHighlightName(c);if(t){const i=()=>{const e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},s=(0,r.tE)(_,t,i);if(e>=s.length)throw new a.A("internal:lod-renderer","LodRenderer internal error - missing lodLevel ".concat(e));ce(s[e],h,c)}g|=z.HIGHLIGHT_ACTIVE}else ce(this._defaultRenderInstanceData[e],h,c),g|=z.DEFAULT_ACTIVE;h.state.set(c,g),h.lodLevel.set(c,e)}else g=u&~(z.ACTIVE|z.TRANSFORM_CHANGED),h.state.set(c,g);if(null!=this._octreeCached){const e=!!(u&z.ACTIVE),t=!!(g&z.ACTIVE);!e&&t?this._octreeCached.addInstance(c):e&&!t?this._octreeCached.removeInstance(c):e&&t&&u&z.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1,c%d===0&&e.madeProgress()}this._instanceIndex=c,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,i){if(0===t.size)return null;const s=i.glMaterials.load(e.rctx,e.bind.slot,e.output);return null===s||void 0===s?void 0:s.beginSlot(e.bind)}_renderComponent(e,t,i,s,n){if(!t)return;const{bind:a,rctx:r}=e;r.runAppleAmdDriverHelper();const h=r.bindTechnique(t,a,s.material.parameters,me);r.bindVAO(s.vao),t.ensureAttributeLocations(s.vao),f.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===v.V.Color&&(h.setUniform4fv("externalColor",pe[Math.min(n,pe.length-1)]),h.setUniform1i("colorMixMode",se.Um.replace));const o=i.capacity,l=i.headIndex,c=i.tailIndex,d=i.firstIndex,_=this._glInstanceBufferLayout,u=(e,n)=>{(0,oe.yu)(r,A.D,i.buffer,_,e),r.drawArraysInstanced(t.primitiveType,0,s.vertexCount,n-e),(0,oe.Hi)(r,A.D,i.buffer,_)};s.material.transparent&&null!=d?l>c?((0,S.vA)(d>=c&&d<=l,"invalid firstIndex"),u(d,l),u(c,d)):l<c&&(d<=l?((0,S.vA)(d>=0&&d<=l,"invalid firstIndex"),u(d,l),u(c,o),u(0,d)):((0,S.vA)(d>=c&&d<=o,"invalid firstIndex"),u(d,o),u(0,l),u(c,d))):l>c?u(c,l):l<c&&(u(0,l),u(c,o)),r.bindVAO(null)}};function ce(e,t,i){const s=e.allocateHead();!function(e,t,i,s){(0,ne.Vk)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,e.model,t),i.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(s,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,e.featureAttribute,t)}(t,i,e.view,s)}(0,s._)([(0,l.MZ)({constructOnly:!0})],le.prototype,"symbol",void 0),(0,s._)([(0,l.MZ)({constructOnly:!0})],le.prototype,"optionalFields",void 0),(0,s._)([(0,l.MZ)({constructOnly:!0})],le.prototype,"metadata",void 0),(0,s._)([(0,l.MZ)({constructOnly:!0})],le.prototype,"shaderTransformation",void 0),(0,s._)([(0,l.MZ)()],le.prototype,"_instanceData",void 0),(0,s._)([(0,l.MZ)()],le.prototype,"_cycleStartIndex",void 0),(0,s._)([(0,l.MZ)({readOnly:!0})],le.prototype,"_enableLevelSelection",null),(0,s._)([(0,l.MZ)()],le.prototype,"_updateCyclesWithStaticCamera",void 0),(0,s._)([(0,l.MZ)({readOnly:!0})],le.prototype,"running",null),le=(0,s._)([(0,c.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],le);const de=(0,u.vt)(),_e=(0,g.vt)(),ue=(0,d.vt)(),ge=(0,u.vt)(),fe=(0,u.vt)(),pe=[(0,g.fA)(1,0,1,1),(0,g.fA)(0,0,1,1),(0,g.fA)(0,1,0,1),(0,g.fA)(1,1,0,1),(0,g.fA)(1,0,0,1)],me=new ae.V}}]);
//# sourceMappingURL=3595.37cb52d1.chunk.js.map