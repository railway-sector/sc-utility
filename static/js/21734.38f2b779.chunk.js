"use strict";(self.webpackChunksc_utility=self.webpackChunksc_utility||[]).push([[21734],{21734:(e,t,r)=>{r.r(t),r.d(t,{destroyContext:()=>w,dracoDecompressPointCloudData:()=>p,filterObbsForModifications:()=>d,filterObbsForModificationsSync:()=>M,initialize:()=>j,interpretObbModificationResults:()=>L,process:()=>h,project:()=>g,setLegacySchema:()=>m,setModifications:()=>y,setModificationsSync:()=>v,test:()=>F,transformNormals:()=>b});var s=r(15941),n=r(13312),o=r(44815),i=r(14894),a=r(5845),c=r(45136),f=r(28899);let l;var u=r(97048);async function h(e){E=await N();const t=[e.geometryBuffer];return{result:x(E,e,t),transferList:t}}async function p(e){var t;E=await N();const r=[e.geometryBuffer],{geometryBuffer:s}=e,n=s.byteLength,o=E._malloc(n),i=new Uint8Array(E.HEAPU8.buffer,o,n);i.set(new Uint8Array(s));const a=E.dracoDecompressPointCloudData(o,i.byteLength);if(E._free(o),a.error.length>0)throw new Error("i3s.wasm: ".concat(a.error));const c=(null===(t=a.featureIds)||void 0===t?void 0:t.length)>0?a.featureIds.slice():null,f=a.positions.slice();return c&&r.push(c.buffer),r.push(f.buffer),{result:{positions:f,featureIds:c},transferList:r}}async function d(e){await N(),M(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function y(e){await N(),v(e)}async function m(e){E=await N(),E.setLegacySchema(e.context,e.jsonSchema)}async function g(e){const{localMatrix:t,origin:s,positions:c,vertexSpace:f}=e,l=n.A.fromJSON(e.inSpatialReference),u=n.A.fromJSON(e.outSpatialReference),h=t?(0,o.Vj)(t):void 0,p=(0,o.cj)(s);let d;const[{projectBuffer:y},{initializeProjection:m}]=await Promise.all([Promise.resolve().then(r.bind(r,45308)),Promise.resolve().then(r.bind(r,56611))]);await m(l,u);const g=[0,0,0];if(!y(p,l,0,g,u,0))throw new Error("Failed to project");if("georeferenced"===f.type&&null==f.origin){if(d=new Float64Array(c.length),!y(c,l,0,d,u,0,d.length/3))throw new Error("Failed to project")}else{const e="georeferenced"===f.type?i.A.fromJSON(f):a.A.fromJSON(f),{projectMeshVertexPositions:t}=await r.e(22956).then(r.bind(r,22956)),s=t({vertexAttributes:{position:c},transform:h?{localMatrix:h}:void 0,vertexSpace:e,spatialReference:l},u);if(!s)throw new Error("Failed to project");d=s}const b=d.length,[w,A,E]=g;for(let r=0;r<b;r+=3)d[r]-=w,d[r+1]-=A,d[r+2]-=E;return{result:{projected:d,original:c,projectedOrigin:g},transferList:[d.buffer,c.buffer]}}async function b(e){let{normalMatrix:t,normals:r}=e;const n=new Float32Array(r.length);return(0,c.b)(n,r,t),(0,s.or)(t)&&(0,c.n)(n,n),{result:{transformed:n,original:r},transferList:[n.buffer,r.buffer]}}function w(e){S(e)}let A,E;function v(e){if(!E)return;const t=e.modifications,r=E._malloc(8*t.length),s=new Float64Array(E.HEAPU8.buffer,r,t.length);for(let n=0;n<t.length;++n)s[n]=t[n];E.setModifications(e.context,r,t.length,e.isGeodetic),E._free(r)}function x(e,t,r){const{context:s,globalTrafo:n,mbs:o,obbData:i,elevationOffset:a,geometryBuffer:c,geometryDescriptor:f,indexToVertexProjector:l,vertexToRenderProjector:h}=t,p=e._malloc(c.byteLength),d=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),y=new Uint8Array(e.HEAPU8.buffer,p,c.byteLength);y.set(new Uint8Array(c));const m=new Float64Array(e.HEAPU8.buffer,d,33);_(m,[NaN,NaN,NaN]);let g=m.byteOffset+3*m.BYTES_PER_ELEMENT,b=new Float64Array(m.buffer,g);_(b,n),g+=16*m.BYTES_PER_ELEMENT,b=new Float64Array(m.buffer,g),_(b,o),g+=4*m.BYTES_PER_ELEMENT,i&&(b=new Float64Array(m.buffer,g),_(b,i));const w=f,A={isDraco:!1,isLegacy:!1,color:t.layouts.some(e=>e.some(e=>"color"===e.name)),normal:t.needNormals&&t.layouts.some(e=>e.some(e=>"normalCompressed"===e.name)),uv0:t.layouts.some(e=>e.some(e=>"uv0"===e.name)),uvRegion:t.layouts.some(e=>e.some(e=>"uvRegion"===e.name)),featureIndex:w.featureIndex},E=e.process(s,!!t.obbData,p,y.byteLength,w,A,d,a,l,h,t.normalReferenceFrame);if(e._free(d),e._free(p),E.error.length>0)throw new Error("i3s.wasm: ".concat(E.error));if(E.discarded)return null;const v=E.componentOffsets.length>0?E.componentOffsets.slice():null,x=E.featureIds.length>0?E.featureIds.slice():null,L=E.anchorIds.length>0?Array.from(E.anchorIds):null,M=E.anchors.length>0?Array.from(E.anchors):null,S=E.interleavedVertedData.slice().buffer,j=1===E.indicesType?new Uint16Array(E.indices.buffer,E.indices.byteOffset,E.indices.byteLength/2).slice():new Uint32Array(E.indices.buffer,E.indices.byteOffset,E.indices.byteLength/4).slice(),N=E.positions.slice(),{buffer:F,byteOffset:P,byteLength:I}=E.positionIndices,O=1===E.positionIndicesType?new Uint16Array(F,P,I/2).slice():new Uint32Array(F,P,I/4).slice(),R=new u._b(t.layouts[0],S,j,E.hasColors,E.hasModifications,{data:N,indices:O});return x&&r.push(x.buffer),v&&r.push(v.buffer),r.push(S),r.push(j.buffer),r.push(N.buffer),r.push(O.buffer),new u.sQ(v,x,L,M,R,n,E.obb)}function L(e){return 0===e?0:1===e?1:2===e?2:3}function M(e){if(!E)return;const{context:t,buffer:r}=e,s=E._malloc(r.byteLength),n=r.byteLength/Float64Array.BYTES_PER_ELEMENT,o=new Float64Array(E.HEAPU8.buffer,s,n),i=new Float64Array(r);o.set(i),E.filterOBBs(t,s,n),i.set(o),E._free(s)}function S(e){E&&0===E.destroy(e)&&(E=null,A=null,l=null)}function _(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function j(){E||await N()}async function N(){return E||(E=await(null!==A&&void 0!==A?A:(null!==l&&void 0!==l||(l=(async()=>{const e=await r.e(77258).then(r.bind(r,77258));return await e.default({locateFile:e=>(0,f.s)("esri/libs/i3s/".concat(e))})})()),A=l))),E}const F={transform:(e,t)=>E&&x(E,e,t),destroy:S}},97048:(e,t,r)=>{r.d(t,{Ir:()=>d,_b:()=>f,sQ:()=>l,xb:()=>u});var s=r(76460),n=r(68930),o=r(9392),i=r(12016),a=r(56611),c=r(14487);class f{constructor(e,t,r,s,n,o){this.layout=e,this.interleavedVertexData=t,this.indices=r,this.hasColors=s,this.hasModifications=n,this.positionData=o}}class l{constructor(e,t,r,s,n,o,i){this.componentOffsets=e,this.featureIds=t,this.anchorIds=r,this.anchors=s,this.transformedGeometry=n,this.globalTrafo=o,this.obb=i}}class u extends i.B{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,r){const s={context:e,modifications:t,isGeodetic:r};return this.broadcast(s,"setModifications")}setLegacySchema(e,t){const r=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:r},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}async destroyContextAndSelf(e){await this.destroyContext(e),this.destroy()}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const h=new n.A({deallocator:null}),p=(0,o.vt)();function d(e,t,r){h.clear();let n=1/0,o=1/0,i=-1/0,f=-1/0,l=!1;for(const d of t){const e="clip"===d.type?2:"mask"===d.type?1:0,t=d.geometry;let u=e=>e;if(t.spatialReference){if(!(0,a.canProjectWithoutEngine)(t.spatialReference,r)){s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:t});continue}u=e=>((0,c.F)(e,t.spatialReference,p,r),p)}else t.hasZ||(p[2]=0,u=e=>(p[0]=e[0],p[1]=e[1],p));l=l||1===e;const y=t.rings.length,m=t.rings.some(e=>e.length<3);if(0===y||m)s.A.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:t});else{h.push(e),h.push(y);for(const e of t.rings){h.push(e.length);for(const t of e){const e=u(t);h.push(e[0]),h.push(e[1]),h.push(e[2]),n=Math.min(n,e[0]),o=Math.min(o,e[1]),i=Math.max(i,e[0]),f=Math.max(f,e[1])}}}}if(null!=e)if(l){const t=1e-4;h.push(2),h.push(2),h.push(4),h.push(n-t),h.push(o-t),h.push(0),h.push(i+t),h.push(o-t),h.push(0),h.push(i+t),h.push(f+t),h.push(0),h.push(n-t),h.push(f+t),h.push(0),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0)}else h.push(1),h.push(1),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0);h.push(3);const u=new Float64Array(h.length);for(let s=0;s<h.length;++s)u[s]=h.at(s);return u}}}]);
//# sourceMappingURL=21734.38f2b779.chunk.js.map