"use strict";(self.webpackChunksc_utility=self.webpackChunksc_utility||[]).push([[4375],{4375:(e,t,n)=>{n.d(t,{L:()=>H});var s=n(6326),i=n(18690),a=n(50076),r=n(87663),o=n(30726),l=n(50346),c=n(46053),h=(n(81806),n(76460),n(87990)),d=n(13191),u=n(20664),_=n(9392),g=n(55855),m=n(22955),p=n(57481),f=n(33062),v=n(60586),y=n(89596),b=n(86994),C=n(42589),I=n(78315),S=n(94966),D=n(94536);class R extends D.x{constructor(e,t){super(e=>(0,I.A)(this._instanceData.view.boundingSphere.getVec(e,E)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,I.c)(),this._tmpMat4=(0,d.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,I.q)(this._tmpSphere,this._boundingSphere.center,n),this._tmpSphere[3]=this._boundingSphere.radius*(0,S.hG)(n),t.setVec(e,(0,I.y)(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const E=(0,g.vt)();class x{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,n){const s=n.computeScreenPixelSizeAt(e),i=this._worldSpaceRadius*t/s;let a=0;for(let r=1;r<this._minScreenSpaceRadii.length;++r)i>=this._minScreenSpaceRadii[r]&&(a=r);return a}}var w=n(42294),M=n(50255),T=n(69008),A=n(9243);class L{constructor(e,t){this.geometry=t;const n=e.renderContext.rctx,s=t.renderGeometry,{material:i,layout:a,buffer:r}=s;this._materials=e.materials,i.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new M.c(i,this._materials),this.vbo=new A.R(n,(0,p.U)(a),r),this.vao=new T.Z(n,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,n,s,i,a,r,o){return this.geometry.intersect(e,t,n,s,i,a,r,o)}}class O{static async create(e,t,n){const s=await Promise.allSettled(t.components.map(t=>e.controller.schedule(()=>new L(e,t.geometry),n))),a=s.map(e=>"fulfilled"===e.status?e.value:null).filter(i.Ru);if((0,l.G4)(n)||a.length!==s.length){a.forEach(e=>e.destroy()),(0,l.Te)(n);for(const e of s)if("rejected"===e.status)throw e.reason}return new O(t.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,n,s,i,a,r){this.components.forEach(o=>o.intersect(e,t,n,s,i,a,this.boundingSphere,r))}get boundingBox(){if(null==this._boundingBox){const e=(0,w.Ie)();this.components.forEach(t=>{null!=t.boundingInfo&&((0,w.iT)(e,t.boundingInfo.bbMin),(0,w.iT)(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,_.vt)();(0,w.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,w._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}}var U=n(53760),B=n(99362),V=n(68967),P=n(37267),q=n(1723),N=n(59752),F=n(27207),G=n(75757);let H=class extends v.Cc{constructor(e,t){super(e),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new f.A,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new C.e7({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(N.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=(0,U.Qm)(this.symbol.materialParameters),this._glInstanceBufferLayout=(0,p.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",e=>{let{index:t}=e;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",e=>{let{index:t}=e;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDatas)t[0]!==q.Tv&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,n)=>{const s=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,i=e.triangleCount;t.push({renderedInstances:s,renderedTriangles:s*i,trianglesPerInstance:i})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new U.Ui(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(n=>O.create(e,n,t))),s=n.map(e=>"fulfilled"===e.status?e.value:null).filter(i.Ru);if((0,l.G4)(t)||s.length!==n.length){s.forEach(e=>e.destroy()),(0,l.Te)(t);for(const e of n)if("rejected"===e.status)throw e.reason}this._levels=s,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,n=e.levels.map(e=>e.minScreenSpaceRadius);return new x(t,n)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>{const t=e.material.produces.get(4);return null===t||void 0===t?void 0:t(0)}))}hasHighlights(){return(0,r.Bs)(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(9!==e||this.hasHighlights())&&(5!==e||this.hasHighlight(q.Tv))}prepareRender(e){if(!m.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(N.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const n=new Array,s=this.levels;return t.forEach(t=>s.forEach((s,i)=>{let{components:a}=s;return a.forEach(s=>n.push(this._beginComponent(e,t[i],s)))})),n}render(e,t){const n=this._getInstanceDatas(e);if(!n||null==t)return;let s=0;const i=this.levels;n.forEach(n=>i.forEach((i,a)=>{let{components:r}=i;return r.forEach(i=>this._renderComponent(e,t[s++],n[a],i,a))})),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){const{output:t,bind:n}=e,s=9===t,i=5===t,a=6!==t;if(!s&&!i)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:r}=this;if(a){if(s){var o;const e=null===(o=n.highlight)||void 0===o?void 0:o.name;if(!e)return null;const t=r.get(e);return t?[t]:null}const e=r.get(q.Tv);return i?e?[e]:null:Array.from(r.values())}return null}intersect(e,t,n,s){if(!this.baseMaterial.visible||null==this._octree)return;const i=(0,_.vt)();(0,u.e)(i,s,n);const a=i=>{this._instanceData.getCombinedModelTransform(i,W),e.transform.set(W),(0,u.t)(j,n,e.transform.inverse),(0,u.t)(X,s,e.transform.inverse);const a=this._instanceData.getState(i),r=this._instanceData.getLodLevel(i),o=this._levels.length;4&a&&((0,b.vA)(!!(18&a),"invalid instance state"),(0,b.vA)(r>=0&&r<o,"invaid lod level"),this._levels[r].intersect(e,t,j,X,i,this.metadata,o))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(n,i,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var e;const t=this._instanceData,n=null===(e=t.view)||void 0===e?void 0:e.state;if(!n)return null;this._octreeCached=new R(t,this.baseBoundingSphere);for(let e=0;e<t.capacity;++e)18&n.get(e)&&this._octreeCached.addInstance(e)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,o.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new y.d;const t=e.viewForward,n=this._octree.findClosest(t,1,e.frustum),s=this._octree.findClosest(t,-1,e.frustum);if(null==n||null==s)return new y.d;const i=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(n,k),(0,u.e)(k,k,i);const r=(0,u.f)(k,t)-k[3];a.boundingSphere.getVec(s,k),(0,u.e)(k,k,i);const o=(0,u.f)(k,t)+k[3];return new y.d(r,o)}_requestUpdateCycle(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:n,_levelSelector:s}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));const i=this._instanceData,o=i.view;let l=i.size;const c=i.capacity;let h=this._instanceIndex;const d=Math.ceil(c/500),{_highlightRenderInstanceDatas:u}=this;for(let _=0;_<l&&!e.done;++_){h===this._cycleStartIndex&&this._startUpdateCycle();const _=o.state.get(h);let g=0;if(!(1&_)){h=h+1===c?0:h+1,l++;continue}const m=o.lodLevel.get(h);if(2&_&&this._defaultRenderInstanceData[m].freeTail(),16&_){const e=i.geHighlightOptionsPrev(h);if(e){const t=u.get(e);if(!t)throw new a.A("internal:lod-renderer","Internal error in lodRenderer");t[m].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),u.delete(e))}}if(32&_)i.freeInstance(h);else if(4&_){let e=0;if(t&&(o.modelOrigin.getVec(h,Z),e=s.selectLevel(Z,i.getCombinedMedianScaleFactor(h),n)),g=-83&_,e>=0)if(8&_){const t=i.getHighlightName(h);if(t){const n=()=>{const e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},s=(0,r.tE)(u,t,n);if(e>=s.length)throw new a.A("internal:lod-renderer","LodRenderer internal error - missing lodLevel ".concat(e));z(s[e],o,h)}g|=16}else z(this._defaultRenderInstanceData[e],o,h),g|=2;o.state.set(h,g),o.lodLevel.set(h,e)}else g=-83&_,o.state.set(h,g);const p=!!(18&_),f=!!(18&g);null!=this._octreeCached&&(!p&&f?this._octreeCached.addInstance(h):p&&!f?this._octreeCached.removeInstance(h):p&&f&&64&_&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))),h=h+1===c?0:h+1,h%d===0&&e.madeProgress(),p!==f&&this.metadata.notifyGraphicVisibilityChanged(h),f&&64&_&&this.metadata.notifyGraphicGeometryChanged(h)}this._instanceIndex=h,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,n){if(0===t.size)return null;const s=n.glMaterials.load(e.rctx,e.bind.slot,e.output);return null===s||void 0===s?void 0:s.beginSlot(e.bind)}_renderComponent(e,t,n,s,i){if(!t)return;const{bind:a,rctx:r}=e;r.runAppleAmdDriverHelper();const o=r.bindTechnique(t,a,s.material.parameters,Y),l=this._glInstanceBufferLayout;o.assertCompatibleVertexAttributeLocations(s.vao,(0,G.Xk)(l)),r.bindVAO(s.vao),m.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.output&&(o.setUniform4fv("externalColor",Q[Math.min(i,Q.length-1)]),o.setUniform1i("symbolColorMixMode",B.Um.replace));const c=n.capacity,h=n.headIndex,d=n.tailIndex,u=n.firstIndex,_=(e,i)=>{(0,F.yu)(r,o.locations,n.buffer,e),r.drawArraysInstanced(t.primitiveType,0,s.numVertices,i-e)};s.material.transparent&&null!=u?h>d?((0,b.vA)(u>=d&&u<=h,"invalid firstIndex"),_(u,h),_(d,u)):h<d&&(u<=h?((0,b.vA)(u>=0&&u<=h,"invalid firstIndex"),_(u,h),_(d,c),_(0,u)):((0,b.vA)(u>=d&&u<=c,"invalid firstIndex"),_(u,c),_(0,h),_(d,u))):h>d?_(d,h):h<d&&(_(0,h),_(d,c))}};function z(e,t,n){const s=e.allocateHead();!function(e,t,n,s){(0,V.Vk)(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,e.model,t),n.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(s,e.color,t),e.olidColor&&n.olidColor&&n.olidColor.copyFrom(s,e.olidColor,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,e.featureAttribute,t)}(t,n,e.view,s)}(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],H.prototype,"symbol",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],H.prototype,"metadata",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],H.prototype,"shaderTransformation",void 0),(0,s.Cg)([(0,c.MZ)()],H.prototype,"_instanceData",void 0),(0,s.Cg)([(0,c.MZ)()],H.prototype,"_cycleStartIndex",void 0),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],H.prototype,"_enableLevelSelection",null),(0,s.Cg)([(0,c.MZ)()],H.prototype,"_updateCyclesWithStaticCamera",void 0),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],H.prototype,"readyToRun",null),H=(0,s.Cg)([(0,h.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],H);const Z=(0,_.vt)(),k=(0,g.vt)(),W=(0,d.vt)(),j=(0,_.vt)(),X=(0,_.vt)(),Q=[(0,g.CN)(1,0,1,1),(0,g.CN)(0,0,1,1),(0,g.CN)(0,1,0,1),(0,g.CN)(1,1,0,1),(0,g.CN)(1,0,0,1)],Y=new P.V}}]);
//# sourceMappingURL=4375.6ea4e08a.chunk.js.map