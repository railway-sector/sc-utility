"use strict";(self.webpackChunksc_utility=self.webpackChunksc_utility||[]).push([[12843],{12843:(e,t,r)=>{r.d(t,{FeatureSnappingEngine:()=>P});var i=r(35143),n=r(91967),a=r(18690),l=r(54901),o=r(81806),s=r(43927),u=r(50346),d=r(68134),c=r(31633),p=r(46053),v=r(76460),h=r(85842),y=r(19555),g=r(20664),f=r(9392),S=r(53494),w=r(19451),_=r(12482),m=r(75543),b=r(23862),F=r(89379),M=r(34154),R=(r(47249),r(8203)),x=r(46530),A=r(31933),E=r(70330),L=r(90992);let C=class extends n.A{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){var e;return null===(e=this.view)||void 0===e||null===(e=e.allLayerViews)||void 0===e?void 0:e.find(e=>e.layer===this.layer)}get valid(){const{_valid:e,snappingSource:t,layer:r}=this;return!(!t||!r)&&e}get subtypeFilter(){var e,t,r;const{layer:i,snappingSource:n}=this;if(!(0,A.F2)(i)||null===(e=i.subtypes)||void 0===e||!e.length||!n)return{mode:"not-in-use",filter:null};const a=n.layerSource.sublayerSources.filter(e=>{var t;return e.enabled&&e.layer.visible&&(0,L.JU)(null===(t=this.view)||void 0===t?void 0:t.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)}).map(e=>e.layer.subtypeCode);if(!a.length)return{mode:"none-visible",filter:null};if(a.length===i.subtypes.length)return{mode:"all-visible",filter:null};const l=null!==(t=null===(r=i.fieldsIndex.get(i.subtypeField))||void 0===r?void 0:r.name)&&void 0!==t?t:i.subtypeField;return 1===a.length?{mode:"in-use",filter:"".concat(l," = ").concat(a.getItemAt(0))}:{mode:"in-use",filter:"".concat(l," IN (").concat(a.join(", "),")")}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?(0,x.E)({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const r=e;this.addHandles(r.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([(0,d.wB)(()=>t.updating,e=>t.layerSource.updating=e,d.pc),(0,d.wB)(()=>t.availability,e=>t.layerSource.availability=e,d.pc)])}getFetchCandidatesParameters(e,t,r){var i,n,a,l,s;if(!this.valid)return[];const{layer:u,layerView:d,floorFilter:c,rulesTable:p,subtypeFilter:v}=this,h=(0,F.A)((0,F.A)({distance:r,mode:null!==(i=null===(n=this.view)||void 0===n?void 0:n.type)&&void 0!==i?i:"2d",point:e,coordinateHelper:t.coordinateHelper},{returnEdge:!0,vertexMode:"all"}),{},{filter:d&&"filter"in d?d.filter:null});if(c&&(h.filter=T(h.filter,c)),"not-in-use"!==v.mode&&"all-visible"!==v.mode){if("none-visible"===v.mode)return[];h.filter?h.filter.where=(0,M.mA)(h.filter.where,v.mode):h.filter=new R.A({where:v.filter})}if(!this.attributeRulesEnabled)return[h];const y=t.feature,g="subtype-sublayer"===(null===y||void 0===y||null===(a=y.sourceLayer)||void 0===a?void 0:a.type)?y.sourceLayer.parent:null===y||void 0===y?void 0:y.sourceLayer;if(p&&y&&(0,E.Tu)(null===(l=this.view)||void 0===l?void 0:l.map)&&((0,A.yZ)(u)||(0,A.F2)(u))&&((0,A.yZ)(g)||(0,A.F2)(g))&&null!==(s=this.view.map.utilityNetworks)&&void 0!==s&&s.find(e=>e.isUtilityLayer(g))){var f,S;if("loaded"!==p.loadStatus)return[];const e=[],t=u.layerId,r=null===(f=p.getFeatureSQL(g,y))||void 0===f?void 0:f[t];if(!r)return[];const i=r.anyVertex;let n=r.endVertex;return n&&i&&n===i&&(n=""),n&&e.push((0,F.A)((0,F.A)({},h),{},{returnEdge:!1,vertexMode:"ends",filter:T(h.filter,n)})),i&&e.push((0,F.A)((0,F.A)({},h),{},{returnEdge:null!==(S=(0,o.A)("snapping-include-edges-when-applying-any-vertex-rule"))&&void 0!==S&&S,vertexMode:"all",filter:T(h.filter,i)})),e}return[h]}async loadRules(){this._valid=null;const{layer:e,view:t,attributeRulesEnabled:r}=this;if(r&&e&&t&&(0,E.Tu)(null===t||void 0===t?void 0:t.map)&&((0,A.yZ)(e)||(0,A.F2)(e)))try{var i,n,a,l;await Promise.allSettled(null!==(i=null===(n=t.map.utilityNetworks)||void 0===n?void 0:n.map(e=>e.load()))&&void 0!==i?i:[]);const r=null===(a=t.map.utilityNetworks)||void 0===a?void 0:a.find(t=>t.isUtilityLayer(e));r&&(this.rulesTable=await r.getRulesTable(),await(null===(l=this.rulesTable)||void 0===l?void 0:l.load()))}catch(o){return this._valid=!1,void v.A.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){var e;null===(e=this.snappingSource)||void 0===e||e.destroy()}};function T(e,t){return null==e?new R.A({where:t}):e.where?new R.A({where:(0,M.mA)(e.where,t)}):new R.A({where:t})}(0,i._)([(0,p.MZ)({constructOnly:!0})],C.prototype,"layer",void 0),(0,i._)([(0,p.MZ)({constructOnly:!0})],C.prototype,"snappingSource",void 0),(0,i._)([(0,p.MZ)({constructOnly:!0})],C.prototype,"view",void 0),(0,i._)([(0,p.MZ)({value:!1})],C.prototype,"attributeRulesEnabled",null),(0,i._)([(0,p.MZ)()],C.prototype,"layerView",null),(0,i._)([(0,p.MZ)()],C.prototype,"rulesTable",void 0),(0,i._)([(0,p.MZ)()],C.prototype,"valid",null),(0,i._)([(0,p.MZ)()],C.prototype,"subtypeFilter",null),(0,i._)([(0,p.MZ)()],C.prototype,"floorFilter",null),(0,i._)([(0,p.MZ)()],C.prototype,"_valid",void 0),C=(0,i._)([(0,h.$)("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],C);var I=r(99791),Z=r(80794),z=r(9876),H=r(61751),G=r(78228),O=r(17072);let P=class extends n.A{get updating(){return this._snappingSources.some(e=>{var t;return null==(null===e||void 0===e?void 0:e.valid)||!0===e.valid&&!0===(null===(t=e.snappingSource)||void 0===t?void 0:t.updating)})||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=I.n.FEATURE,this._updatingHandles=new w.U,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=(0,s.l)(()=>{var e;return null===(e=this.options)||void 0===e?void 0:e._effectiveFeatureSources},(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([(0,l.DQ)(e),(0,d.wB)(()=>{var e;return{rulesEnabled:!(null===(e=this.options)||void 0===e||!e.attributeRulesEnabled),sources:this._snappingSources.filter(a.Ru)}},e=>{let{rulesEnabled:t,sources:r}=e;for(const i of r)i.attributeRulesEnabled=t},d.OH)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,r,i){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const n=[],a=this._computeScreenSizeDistanceParameters(e,r);for(const u of this._snappingSources){var l,o;if(null===u||void 0===u||!u.valid||null===(l=u.snappingSource)||void 0===l||null===(l=l.layerSource)||void 0===l||!l.enabled||null!==(o=u.layerView)&&void 0!==o&&o.suspended)continue;const t=u.getFetchCandidatesParameters(e,r,a);for(const e of t)n.push(u.snappingSource.fetchCandidates(e,i).then(e=>e.filter(e=>!this._candidateIsExcluded(u.snappingSource,e,r.excludeFeature))))}const s=(await(0,u.nA)(n)).flat();return this._addRightAngleCandidates(s,e,a,r),(0,u.Te)(i),(0,E.xX)(e,s),s}_addRightAngleCandidates(e,t,r,i){var n,a,l,o;const s=null!=i.vertexHandle?null===(n=i.vertexHandle.rightEdge)||void 0===n||null===(n=n.rightVertex)||void 0===n?void 0:n.pos:null!=i.editGeometryOperations&&"polygon"===i.editGeometryOperations.data.type?null===(a=i.editGeometryOperations.data.components[0])||void 0===a||null===(a=a.getFirstVertex())||void 0===a?void 0:a.pos:null,u=null!=i.vertexHandle?null===(l=i.vertexHandle.leftEdge)||void 0===l||null===(l=l.leftVertex)||void 0===l?void 0:l.pos:null!=i.editGeometryOperations?null===(o=i.editGeometryOperations.data.components[0])||void 0===o||null===(o=o.getLastVertex())||void 0===o?void 0:o.pos:null,{view:d}=this,c=(0,b.Lp)(s,d,i),p=(0,b.Lp)(u,d,i),v=e.length;for(let h=0;h<v;h++)this._addRightAngleCandidate(e[h],p,t,r,e),this._addRightAngleCandidate(e[h],c,t,r,e)}_addRightAngleCandidate(e,t,r,i,n){if(null==t||!function(e){return(e instanceof z.z||e instanceof Z.X)&&!function(e){let{constraint:{start:t,end:r}}=e;const i=(0,g.s)(t,r),n=(0,y.hG)((0,b.Xz)(t),(0,b.Xz)(r));return i<(0,S.FD)()||n/i<X}(e)}(e))return;const a=e.constraint.closestTo(t),l=(a[0]-r[0])/i.x,o=(a[1]-r[1])/i.y,{start:s,end:u}=e.constraint;if(l*l+o*o<=1){const r=(0,y.hG)((0,b.Xz)(a),(0,b.Xz)(s))>(0,y.hG)((0,b.Xz)(a),(0,b.Xz)(u))?s:u,i=new G.HJ({targetPoint:(0,b.de)(a),otherVertex:t,otherVertexType:G.pn.NEXT,previousVertex:r,constraint:new m.FX(t,a),objectId:e.objectId,isDraped:e.isDraped,domain:I.n.FEATURE});n.push(i)}}_computeScreenSizeDistanceParameters(e,t){let r=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:r,y:r,z:r,distance:r}:"2d"===this.view.type?(r*=this.view.resolution,{x:r,y:r,z:r,distance:r}):this._computeScreenSizeDistanceParameters3D(e,r,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,r,i){const{spatialReference:n}=i;r.renderCoordsHelper.toRenderCoords(e,n,j);const a=r.state.camera.computeScreenPixelSizeAt(j),l=a*r.renderCoordsHelper.unitInMeters,o=l/(0,c.GA)(n),s=l/(0,c.G9)(n),u=t*o,d=t*s,p=(0,O.j)(e,n,_.qt,r),v=p?V(p,e,o,0,0,r,i):0,h=p?V(p,e,0,o,0,r,i):0,y=p?V(p,e,0,0,s,r,i):0;return{x:0===v?0:u/v,y:0===h?0:u/h,z:0===y?0:d/y,distance:a*t}}_candidateIsExcluded(e,t,r){if(null==r)return!1;const i=this._getCandidateObjectId(t);if(null==i)return!1;const n=e.layerSource.layer;return"graphics"===n.type?r.uid===i:r.sourceLayer===n&&!(!r.attributes||!("objectIdField"in n))&&r.attributes[n.objectIdField]===i}_getCandidateObjectId(e){return e instanceof H.w?e.objectId:null}async _createSourceInfo(e,t){const r=e.layer;r.loaded||(await r.load(),(0,u.Te)(t));const{view:i}=this,n=await this._createFeatureSnappingSourceType(e);return(0,u.Te)(t),new C(null==n?{}:{snappingSource:n,view:i,layer:r})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch(null===(t=e.layer.source)||void 0===t?void 0:t.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>{var t,r;return null!==(t=null===(r=e.layer.sublayers)||void 0===r?void 0:r.toArray())&&void 0!==t?t:[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),r={module:null,loader:t};this._sourceModules[e]=r;const i=await t,n={module:i,loader:t};return this._sourceModules[e]=n,i}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(r.e(85376).then(r.bind(r,85376)));case"featureCollection":return t.addPromise(r.e(77567).then(r.bind(r,77567)));case"graphics":case"notes":return t.addPromise(Promise.all([r.e(99985),r.e(98683),r.e(72003),r.e(48094),r.e(36e3),r.e(99546)]).then(r.bind(r,99546)));case"scene":return t.addPromise(r.e(13537).then(r.bind(r,13537)))}}get test(){}};function V(e,t,r,i,n,a,l){let{spatialReference:o}=l;const s=(0,g.c)(D,t);s[0]+=r,s[1]+=i,s[2]+=n;const u=(0,O.j)(s,o,_.qt,a);return u?(0,E.Mo)(u,e):1/0}(0,i._)([(0,p.MZ)({constructOnly:!0})],P.prototype,"spatialReference",void 0),(0,i._)([(0,p.MZ)({constructOnly:!0})],P.prototype,"view",void 0),(0,i._)([(0,p.MZ)()],P.prototype,"options",void 0),(0,i._)([(0,p.MZ)({readOnly:!0})],P.prototype,"updating",null),(0,i._)([(0,p.MZ)()],P.prototype,"_snappingSources",void 0),P=(0,i._)([(0,h.$)("esri.views.interactive.snapping.FeatureSnappingEngine")],P);const j=(0,f.vt)(),D=(0,f.vt)(),X=1e-4}}]);
//# sourceMappingURL=12843.47159e72.chunk.js.map